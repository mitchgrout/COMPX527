---
- hosts: ec2
  remote_user: ubuntu
  become: true
  gather_facts: false

  tasks:
    - name: Check for Python
      raw: test -e /usr/bin/python3
      changed_when: false
      failed_when: false
      register: check_python3

    - name: Install Python
      raw: apt-get -y update && apt-get install -y python3
      when: check_python3.rc != 0

- hosts: ec2
  remote_user: ubuntu
  become: true
  gather_facts: true

  tasks:
    - set_fact:
        ansible_python_interpreter: /usr/bin/python3

    - name: Check hosts are running
      ping:

    - name: Run apt-get update/upgrade
      apt:
        update_cache: yes
        upgrade: yes

    - name: Fetch Pip
      apt:
        name: python3-pip

    - name: Update Pip
      pip:
        name: pip

    - name: Fetch APT dependencies 
      apt:
        name: [libopencv-dev, php7.0-curl, php7.0, php7.0-cgi, lighttpd]

    - name: Fetch Pip dependencies
      pip:
        name: [flask, numpy, keras, tensorflow] 

    - name: Install keras_retinanet
      pip:
        name: git+https://github.com/fizyr/keras-retinanet

    - name: Install backend
      synchronize:
        src: ../backend/
        dest: /home/ubuntu/backend/

    - name: Fetching weights
      shell: cd backend/;wget https://github.com/fizyr/keras-retinanet/releases/download/0.5.1/resnet50_coco_best_v2.1.0.h5

    - name: Start backend
      shell: cd backend/; nohup python3 main.py >log 2>err&

    - name: Enable PHP7 for lighttpd
      shell: lighty-enable-mod fastcgi && lighty-enable-mod fastcgi-php

    - name: Restarting lighttpd
      shell: service lighttpd force-reload
