---
- hosts: ec2
  remote_user: ubuntu
  become: true
  gather_facts: false

  tasks:
    - name: Check for Python
      raw: test -e /usr/bin/python
      changed_when: false
      failed_when: false
      register: check_python

    - name: Install Python
      raw: apt-get -y update && apt-get install -y python-minimal
      when: check_python.rc != 0

- hosts: ec2
  remote_user: ubuntu
  become: true
  gather_facts: true

  tasks:
    - set_fact:
        ansible_python_interpreter: /usr/bin/python

    - name: Check hosts are running
      ping:

    - name: Run apt-get update/upgrade
      apt:
        update_cache: yes
        upgrade: yes

    - name: Install apt-transport-https
      apt:
        name: apt-transport-https

    - name: Download Docker key
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /tmp/apt-key.gpg

    - name: Register Docker key
      shell: apt-key add /tmp/apt-key.gpg

    - name: Register Docker apt repo
      shell: echo "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable" > /etc/apt/sources.list.d/docker.list

    - name: Run apt-get update/upgrade again
      apt:
        update_cache: yes
        upgrade: yes

    - name: Install Docker
      apt: 
        name: [docker-ce, docker-ce-cli, containerd.io]

    - name: Start Darknet server
      shell: docker run --name darknet-server --restart always --detach -p 8080:8080 glenncumming/darknet-server

    - name: Install lighttpd
      apt:
        name: lighttpd

    - name: Install PHP7
      apt:
        name: [php7.0, php7.0-cgi]

    - name: Enable PHP7 for lighttpd
      shell: lighty-enable-mod fastcgi && lighty-enable-mod fastcgi-php

    - name: Restarting lighttpd
      shell: service lighttpd force-reload
